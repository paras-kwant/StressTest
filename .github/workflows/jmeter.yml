name: JMeter Zone Activity Monitor

on:
  schedule:
    - cron: "*/20 * * * *"
  workflow_dispatch:

jobs:
  jmeter-run:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      # ============================================
      # Setup Steps
      # ============================================
      
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Cache JMeter
        id: cache-jmeter
        uses: actions/cache@v3
        with:
          path: apache-jmeter
          key: jmeter-5.6.3
          restore-keys: |
            jmeter-

      - name: Install JMeter
        if: steps.cache-jmeter.outputs.cache-hit != 'true'
        run: |
          JMETER_VERSION=5.6.3
          wget https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-${JMETER_VERSION}.tgz -O jmeter.tgz
          tar -xzf jmeter.tgz
          mv apache-jmeter-${JMETER_VERSION} apache-jmeter

      - name: Add JMeter to PATH
        run: echo "$PWD/apache-jmeter/bin" >> $GITHUB_PATH

      # ============================================
      # Prepare Reports Directory
      # ============================================
      
      - name: Setup reports directory
        run: |
          mkdir -p reports/raw
          mkdir -p reports/html

      - name: Fetch existing reports from gh-pages
        run: |
          git fetch origin gh-pages:gh-pages || echo "No gh-pages branch yet"
          if git show-ref --verify --quiet refs/heads/gh-pages; then
            echo "Fetching existing reports from gh-pages..."
            git checkout gh-pages
            if [ -d "html" ]; then
              cp -r html/* reports/html/ 2>/dev/null || echo "No existing reports to copy"
            fi
            git checkout -
          else
            echo "gh-pages branch doesn't exist yet, this is the first run"
          fi

      # ============================================
      # Run JMeter Test
      # ============================================
      
      - name: Run JMeter Test
        run: |
          export TZ="Asia/Kathmandu"
          TIMESTAMP=$(date +'%Y%m%d_%H%M%S')
          echo "Running test at Nepal Time: $TIMESTAMP"

          # Run JMeter with CSV output for HTML report generation
          jmeter -n \
            -t tests/load_test_kwant.jmx \
            -l reports/raw/results_$TIMESTAMP.csv \
            -e -o reports/html/report_$TIMESTAMP \
            -Jemail=${{ secrets.JMETER_EMAIL }} \
            -Jpassword=${{ secrets.JMETER_PASSWORD }} \
            -Jjmeterengine.force.system.exit=true

          # Run again with XML output for assertion parsing
          jmeter -n \
            -t tests/load_test_kwant.jmx \
            -l reports/raw/results_$TIMESTAMP.xml \
            -Jemail=${{ secrets.JMETER_EMAIL }} \
            -Jpassword=${{ secrets.JMETER_PASSWORD }} \
            -Jjmeterengine.force.system.exit=true \
            -Jjmeter.save.saveservice.output_format=xml \
            -Jjmeter.save.saveservice.assertion_results_failure_message=true

          # Check for failures in CSV
          if [ -f "reports/raw/results_$TIMESTAMP.csv" ]; then
            FAIL_COUNT=$(awk -F',' 'NR>1 && $8=="false" {count++} END {print count+0}' reports/raw/results_$TIMESTAMP.csv)
            if [ "$FAIL_COUNT" -gt 0 ]; then
              echo "‚ùå $FAIL_COUNT assertions failed"
              exit 1
            fi
          fi

          echo $TIMESTAMP > reports/latest_run.txt
          echo "Test completed!"

      # ============================================
      # Process Results
      # ============================================
      
      - name: Extract Assertions to JSON
        run: |
          TIMESTAMP=$(cat reports/latest_run.txt)
          XML_FILE=reports/raw/results_$TIMESTAMP.xml
          JMX_FILE=tests/load_test_kwant.jmx
          ASSERTIONS_FILE=reports/html/report_$TIMESTAMP/assertions.json
          mkdir -p reports/html/report_$TIMESTAMP
          
          cat > parse_jtl.py << 'PYEOF'
          import xml.etree.ElementTree as ET
          import json
          import sys
          
          def get_assertion_config(jmx_file):
              """Extract assertion configurations from JMX file"""
              try:
                  tree = ET.parse(jmx_file)
                  root = tree.getroot()
                  
                  configs = {}
                  
                  # Find ResponseAssertion
                  for resp_assert in root.findall('.//ResponseAssertion'):
                      name = resp_assert.get('testname', 'Response Assertion')
                      test_strings = resp_assert.findall('.//stringProp[@name="Asserion.test_strings"]/stringProp')
                      if test_strings:
                          value = test_strings[0].text
                          configs[name] = f"Response code contains '{value}'"
                  
                  # Find DurationAssertion
                  for dur_assert in root.findall('.//DurationAssertion'):
                      name = dur_assert.get('testname', 'Duration Assertion')
                      duration_prop = dur_assert.find('.//stringProp[@name="DurationAssertion.duration"]')
                      if duration_prop is not None and duration_prop.text:
                          duration = duration_prop.text
                          configs[name] = f"Response time < {duration}ms"
                  
                  return configs
              except Exception as e:
                  print(f"Could not parse JMX: {e}", file=sys.stderr)
                  return {}
          
          # Get assertion configurations from JMX
          assertion_configs = get_assertion_config(sys.argv[2]) if len(sys.argv) > 2 else {}
          
          try:
              tree = ET.parse(sys.argv[1])
              root = tree.getroot()
              
              assertions = []
              seen_assertions = set()
              
              # Find all samples
              for sample in root.findall('.//*[@lb]'):
                  label = sample.get('lb', 'Unknown Request')
                  success = sample.get('s', 'true') == 'true'
                  
                  # Find assertion results
                  assertion_results = sample.findall('.//assertionResult')
                  
                  if assertion_results:
                      for assertion in assertion_results:
                          assertion_name_elem = assertion.find('name')
                          failure = assertion.find('failure')
                          failure_message = assertion.find('failureMessage')
                          
                          is_failure = failure is not None and failure.text == 'true'
                          
                          # Get assertion name
                          if assertion_name_elem is not None and assertion_name_elem.text:
                              assertion_name = assertion_name_elem.text.strip()
                          else:
                              assertion_name = "Assertion"
                          
                          # Build message with configuration details
                          if assertion_name in assertion_configs:
                              message = assertion_configs[assertion_name]
                          else:
                              message = assertion_name
                          
                          # Add failure details if failed
                          if is_failure and failure_message is not None and failure_message.text:
                              fail_msg = failure_message.text.strip()
                              message = f"{message} - FAILED: {fail_msg}"
                          
                          # Create unique key
                          assertion_key = f"{label}|{assertion_name}"
                          
                          if assertion_key not in seen_assertions:
                              seen_assertions.add(assertion_key)
                              assertions.append({
                                  'success': not is_failure,
                                  'endpoint': label,
                                  'message': message
                              })
              
              print(json.dumps(assertions, indent=2))
              
          except Exception as e:
              print(f"Error parsing XML: {e}", file=sys.stderr)
              print("[]")
          PYEOF
          
          python3 parse_jtl.py "$XML_FILE" "$JMX_FILE" > "$ASSERTIONS_FILE" 2>&1
          
          # Debug output
          echo "Generated assertions.json:"
          cat "$ASSERTIONS_FILE"
          
          # Ensure valid JSON
          if [ ! -s "$ASSERTIONS_FILE" ] || ! python3 -m json.tool "$ASSERTIONS_FILE" > /dev/null 2>&1; then
            echo "[]" > "$ASSERTIONS_FILE"
          fi

      - name: Generate Report List
        run: |
          cd reports
          echo "[" > reports.json
          first=true
          for dir in html/report_*; do
            if [ -d "$dir" ]; then
              timestamp=$(basename "$dir" | sed 's/report_//')
              if [ "$first" = true ]; then
                first=false
              else
                echo "," >> reports.json
              fi
              echo -n "  {\"path\": \"$dir\", \"timestamp\": \"$timestamp\"}" >> reports.json
            fi
          done
          echo "" >> reports.json
          echo "]" >> reports.json
          cd ..

      # ============================================
      # Generate Dashboard
      # ============================================
      
      - name: Generate Dashboard
        run: |
          cat > reports/index.html << 'HTMLEND'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Zone Activity API Monitor</title>
            <style>
              * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
              }
              
              body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                padding: 20px;
              }
              
              .container {
                max-width: 1200px;
                margin: 0 auto;
              }
              
              .header {
                background: white;
                padding: 30px;
                border-radius: 15px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
                margin-bottom: 30px;
              }
              
              .header h1 {
                color: #333;
                font-size: 2.5em;
                margin-bottom: 10px;
              }
              
              .endpoint {
                background: #f8f9ff;
                padding: 15px;
                border-radius: 8px;
                border-left: 4px solid #667eea;
                margin: 15px 0;
                font-family: monospace;
              }
              
              .method {
                display: inline-block;
                padding: 4px 12px;
                background: #4CAF50;
                color: white;
                border-radius: 4px;
                font-weight: bold;
                margin-right: 10px;
              }
              
              .badge {
                display: inline-block;
                padding: 8px 20px;
                background: #4CAF50;
                color: white;
                border-radius: 20px;
                margin-top: 15px;
                font-weight: bold;
              }
              
              .reports {
                background: white;
                padding: 30px;
                border-radius: 15px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
              }
              
              .reports h2 {
                color: #333;
                margin-bottom: 20px;
                font-size: 1.8em;
              }
              
              .report-item {
                padding: 20px;
                margin: 15px 0;
                border-left: 5px solid #667eea;
                background: linear-gradient(to right, #f8f9ff, #ffffff);
                border-radius: 8px;
                transition: all 0.3s;
              }
              
              .report-item:hover {
                border-left-color: #4CAF50;
                transform: translateX(5px);
                box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
              }
              
              .run-number {
                font-weight: bold;
                color: #667eea;
                font-size: 1.2em;
                margin-bottom: 8px;
              }
              
              .timestamp {
                color: #666;
                font-size: 0.9em;
                margin-bottom: 15px;
              }
              
              .assertions {
                background: #f0f7ff;
                padding: 15px;
                border-radius: 8px;
                margin-top: 15px;
              }
              
              .assertion {
                display: flex;
                align-items: flex-start;
                gap: 10px;
                margin: 10px 0;
                padding: 10px;
                background: white;
                border-radius: 6px;
                font-size: 0.9em;
              }
              
              .assertion .icon {
                font-size: 1.2em;
                margin-top: 2px;
              }
              
              .assertion-content {
                flex: 1;
              }
              
              .assertion-endpoint {
                font-weight: 600;
                color: #667eea;
                margin-bottom: 4px;
                font-family: monospace;
                font-size: 0.95em;
              }
              
              .assertion-message {
                color: #666;
                font-size: 0.9em;
              }
              
              .view-btn {
                display: inline-block;
                padding: 10px 25px;
                background: #667eea;
                color: white;
                text-decoration: none;
                border-radius: 6px;
                font-weight: bold;
                transition: all 0.3s;
                margin-top: 10px;
              }
              
              .view-btn:hover {
                background: #4CAF50;
                transform: scale(1.05);
              }
            </style>
          </head>
          <body>
            <div class="container">
              <div class="header">
                <h1>üéØ Zone Activity API Monitor</h1>
                <div class="endpoint">
                  <span class="method">GET</span>
                  <span>/api/open/v2/zoneActivity</span>
                </div>
                <div class="badge">‚úì Monitoring Active</div>
                <p style="margin-top:15px;color:#999;">Auto-refresh every 20 minutes</p>
                <p style="margin-top:5px;color:#999;">Last updated: <span id="lastUpdate"></span></p>
              </div>
              
              <div class="reports">
                <h2>üìã Test History (Last 20 Runs)</h2>
                <div id="reportsList">Loading reports...</div>
              </div>
            </div>
            
            <script>
              function toNepalTime(date) {
                return date.toLocaleString('en-US', {
                  year: 'numeric',
                  month: '2-digit',
                  day: '2-digit',
                  hour: '2-digit',
                  minute: '2-digit',
                  second: '2-digit',
                  hour12: true
                });
              }
              
              document.getElementById('lastUpdate').textContent = toNepalTime(new Date()) + ' NPT';

              fetch('reports.json')
                .then(res => res.json())
                .then(reports => {
                  const reportsList = document.getElementById('reportsList');
                  
                  if (!reports || reports.length === 0) {
                    reportsList.innerHTML = '<p style="color:#666;">Reports will appear after first run.</p>';
                    return;
                  }
                  
                  reports.sort((a, b) => parseInt(b.timestamp.replace(/_/g, '')) - parseInt(a.timestamp.replace(/_/g, '')));
                  const last20 = reports.slice(0, 20);
                  
                  last20.forEach((report, index) => {
                    const ts = report.timestamp;
                    const year = ts.substring(0, 4);
                    const month = ts.substring(4, 6);
                    const day = ts.substring(6, 8);
                    const hour = ts.substring(9, 11);
                    const min = ts.substring(11, 13);
                    const sec = ts.substring(13, 15);
                    const date = new Date(year, month - 1, day, hour, min, sec);
                    
                    const item = document.createElement('div');
                    item.className = 'report-item';
                    item.innerHTML = `
                      <div class="run-number">‚úì Run #${index + 1} - Zone Activity API</div>
                      <div class="timestamp">üìÖ ${toNepalTime(date)} NPT</div>
                      <div class="assertions" id="assertions-${index}">
                        <strong>Assertions:</strong>
                      </div>
                      <a href="${report.path}/index.html" class="view-btn" target="_blank">View Full Report ‚Üí</a>
                    `;
                    reportsList.appendChild(item);

                    // Load dynamic assertions
                    fetch(`${report.path}/assertions.json`)
                      .then(res => res.json())
                      .then(assertions => {
                        const div = document.getElementById(`assertions-${index}`);
                        if (assertions.length === 0) {
                          div.innerHTML += '<p style="color:#999;font-size:0.9em;">No assertions data available</p>';
                          return;
                        }
                        assertions.forEach(a => {
                          const icon = a.success ? '‚úì' : '‚ùå';
                          const color = a.success ? '#4CAF50' : '#FF3B30';
                          div.innerHTML += `
                            <div class="assertion">
                              <span class="icon" style="color:${color}">${icon}</span>
                              <div class="assertion-content">
                                <div class="assertion-endpoint">${a.endpoint || 'Unknown Endpoint'}</div>
                                <div class="assertion-message">${a.message || 'No message'}</div>
                              </div>
                            </div>
                          `;
                        });
                      })
                      .catch(err => {
                        console.error('Error loading assertions:', err);
                        const div = document.getElementById(`assertions-${index}`);
                        div.innerHTML += '<p style="color:#999;font-size:0.9em;">Could not load assertions</p>';
                      });
                  });
                })
                .catch(err => {
                  console.error('Error loading reports:', err);
                  document.getElementById('reportsList').innerHTML = '<p style="color:#666;">Error loading reports.</p>';
                });
            </script>
          </body>
          </html>
          HTMLEND

      # ============================================
      # Deploy to GitHub Pages
      # ============================================
      
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./reports
          keep_files: true
          enable_jekyll: false

      - name: Cleanup old reports on gh-pages
        run: |
          cd reports/html
          REPORT_COUNT=$(ls -d report_* 2>/dev/null | wc -l)
          if [ $REPORT_COUNT -gt 20 ]; then
            ls -dt report_* | tail -n +21 | xargs rm -rf
          fi
          cd ../..

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-report-${{ github.run_number }}
          path: reports/
          retention-days: 30