name: JMeter Scheduled Run

on:
  schedule:
    - cron: "*/20 * * * *"  # every 20 minutes
  workflow_dispatch:

jobs:
  jmeter-run:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repository
      - name: Checkout repo
        uses: actions/checkout@v3

      # 2. Set up Java
      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      # 3. Install Maven
      - name: Install Maven
        run: sudo apt-get update && sudo apt-get install -y maven

      # 4. Clone JMeter source and build
      - name: Clone and build JMeter
        run: |
          git clone https://github.com/apache/jmeter.git
          cd jmeter
          mvn -q clean package -DskipTests
          export PATH=$PWD/bin:$PATH
          cd ..

      # 5. Run JMeter CLI
      - name: Run JMeter CLI
        run: |
          TIMESTAMP=$(date +'%Y%m%d_%H%M%S')
          mkdir -p jmeter-logs
          ./jmeter/bin/jmeter -n \
            -t tests/load_test_kwant.jmx \
            -l jmeter-logs/results_$TIMESTAMP.jtl \
            -e -o jmeter-logs/report_$TIMESTAMP \
            -Jemail=${{ secrets.JMETER_EMAIL }} \
            -Jpassword=${{ secrets.JMETER_PASSWORD }}

      # 6. Cleanup old logs (keep last 20)
      - name: Cleanup old logs
        run: |
          cd jmeter-logs
          ls -tp | grep -v '/$' | tail -n +21 | xargs -I {} rm -- {}

      # 7. Upload logs & reports
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-logs-and-reports
          path: |
            jmeter-logs/*.jtl
            jmeter-logs/report_*/
