name: JMeter Scheduled Run

on:
  schedule:
    - cron: "*/20 * * * *"   # every 20 min
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  jmeter-run:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repository
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 2. Set up Java
      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      # 3. Install JMeter stable version
      - name: Install JMeter
        run: |
          JMETER_VERSION=5.6.3
          wget https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-${JMETER_VERSION}.tgz -O jmeter.tgz
          tar -xzf jmeter.tgz
          mv apache-jmeter-${JMETER_VERSION} apache-jmeter

      # 4. Verify JMX file exists
      - name: Verify JMX file
        run: |
          if [ ! -f tests/load_test_kwant.jmx ]; then
            echo "Error: tests/load_test_kwant.jmx not found!"
            exit 1
          fi
          echo "JMX file found successfully"

      # 5. Run JMeter CLI
      - name: Run JMeter CLI
        id: jmeter_run
        run: |
          TIMESTAMP=$(date +'%Y%m%d_%H%M%S')
          RUN_DATE=$(date +'%Y-%m-%d %H:%M:%S')
          mkdir -p reports
          
          echo "Running JMeter test at $RUN_DATE"
          
          # Run JMeter and capture exit code
          set +e
          ./apache-jmeter/bin/jmeter -n \
            -t tests/load_test_kwant.jmx \
            -l reports/results_$TIMESTAMP.jtl \
            -e -o reports/report_$TIMESTAMP \
            -Jemail=${{ secrets.JMETER_EMAIL }} \
            -Jpassword=${{ secrets.JMETER_PASSWORD }}
          
          EXIT_CODE=$?
          set -e
          
          # Save metadata
          echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "RUN_DATE=$RUN_DATE" >> $GITHUB_OUTPUT
          echo "EXIT_CODE=$EXIT_CODE" >> $GITHUB_OUTPUT
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "STATUS=âœ… PASSED" >> $GITHUB_OUTPUT
          else
            echo "STATUS=âŒ FAILED" >> $GITHUB_OUTPUT
          fi

      # 6. Parse test results
      - name: Parse Results
        if: always()
        run: |
          TIMESTAMP=${{ steps.jmeter_run.outputs.TIMESTAMP }}
          if [ -f "reports/results_$TIMESTAMP.jtl" ]; then
            echo "### Test Results Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Count total requests
            TOTAL=$(grep -c "<httpSample" reports/results_$TIMESTAMP.jtl || echo "0")
            # Count successful requests (success="true")
            SUCCESS=$(grep -c 'success="true"' reports/results_$TIMESTAMP.jtl || echo "0")
            # Count failed requests
            FAILED=$(grep -c 'success="false"' reports/results_$TIMESTAMP.jtl || echo "0")
            
            # Calculate success rate
            if [ "$TOTAL" -gt 0 ]; then
              SUCCESS_RATE=$(awk "BEGIN {printf \"%.2f\", ($SUCCESS/$TOTAL)*100}")
            else
              SUCCESS_RATE="0"
            fi
            
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Status | ${{ steps.jmeter_run.outputs.STATUS }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Total Requests | $TOTAL |" >> $GITHUB_STEP_SUMMARY
            echo "| Successful | $SUCCESS |" >> $GITHUB_STEP_SUMMARY
            echo "| Failed | $FAILED |" >> $GITHUB_STEP_SUMMARY
            echo "| Success Rate | ${SUCCESS_RATE}% |" >> $GITHUB_STEP_SUMMARY
            echo "| Run Time | ${{ steps.jmeter_run.outputs.RUN_DATE }} |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“Š [View Full Report](https://paras-kwant.github.io/StressTest/report_$TIMESTAMP/)" >> $GITHUB_STEP_SUMMARY
          fi

      # 7. Create index page for all reports
      - name: Create Reports Index
        if: always()
        run: |
          mkdir -p reports
          cat > reports/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>JMeter Test Reports</title>
            <style>
              body { 
                font-family: Arial, sans-serif; 
                max-width: 1200px; 
                margin: 50px auto; 
                padding: 20px;
                background: #f5f5f5;
              }
              h1 { color: #333; }
              table { 
                width: 100%; 
                border-collapse: collapse; 
                background: white;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
              }
              th, td { 
                padding: 12px; 
                text-align: left; 
                border-bottom: 1px solid #ddd; 
              }
              th { 
                background-color: #4CAF50; 
                color: white; 
              }
              tr:hover { background-color: #f5f5f5; }
              .passed { color: green; font-weight: bold; }
              .failed { color: red; font-weight: bold; }
              a { color: #2196F3; text-decoration: none; }
              a:hover { text-decoration: underline; }
            </style>
          </head>
          <body>
            <h1>ðŸ§ª JMeter Load Test Reports</h1>
            <p>Last updated: <span id="lastUpdate"></span></p>
            <table id="reportsTable">
              <thead>
                <tr>
                  <th>Run Date</th>
                  <th>Status</th>
                  <th>Total Requests</th>
                  <th>Success Rate</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="reportsList">
                <tr><td colspan="5">Loading reports...</td></tr>
              </tbody>
            </table>
            <script>
              // This will be populated by the workflow
              document.getElementById('lastUpdate').textContent = new Date().toLocaleString();
            </script>
          </body>
          </html>
          EOF

      # 8. Update index with current run
      - name: Update Index
        if: always()
        run: |
          TIMESTAMP=${{ steps.jmeter_run.outputs.TIMESTAMP }}
          RUN_DATE="${{ steps.jmeter_run.outputs.RUN_DATE }}"
          STATUS="${{ steps.jmeter_run.outputs.STATUS }}"
          
          if [ -f "reports/results_$TIMESTAMP.jtl" ]; then
            TOTAL=$(grep -c "<httpSample" reports/results_$TIMESTAMP.jtl || echo "0")
            SUCCESS=$(grep -c 'success="true"' reports/results_$TIMESTAMP.jtl || echo "0")
            
            if [ "$TOTAL" -gt 0 ]; then
              SUCCESS_RATE=$(awk "BEGIN {printf \"%.2f\", ($SUCCESS/$TOTAL)*100}")
            else
              SUCCESS_RATE="0"
            fi
            
            # Create a JSON file with run data
            cat > reports/run_$TIMESTAMP.json << EOF
          {
            "timestamp": "$TIMESTAMP",
            "date": "$RUN_DATE",
            "status": "$STATUS",
            "total": $TOTAL,
            "success_rate": $SUCCESS_RATE
          }
          EOF
          fi

      # 9. Checkout gh-pages branch
      - name: Checkout gh-pages
        if: always()
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # Create gh-pages branch if it doesn't exist
          git checkout --orphan gh-pages || git checkout gh-pages
          
          # Remove all files except reports
          git rm -rf . || true
          
          # Copy reports back
          git checkout main -- reports/ || true

      # 10. Keep only last 15 reports
      - name: Cleanup Old Reports
        if: always()
        run: |
          cd reports
          # List all report directories, sort by timestamp, keep last 15
          ls -d report_* 2>/dev/null | sort -r | tail -n +16 | xargs rm -rf || true
          ls results_*.jtl 2>/dev/null | sort -r | tail -n +16 | xargs rm -f || true
          ls run_*.json 2>/dev/null | sort -r | tail -n +16 | xargs rm -f || true

      # 11. Generate dynamic index
      - name: Generate Dynamic Index
        if: always()
        run: |
          cd reports
          cat > index.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>JMeter Test Reports</title>
            <style>
              body { 
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
                max-width: 1400px; 
                margin: 0 auto; 
                padding: 40px 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
              }
              .container {
                background: white;
                border-radius: 10px;
                padding: 30px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.2);
              }
              h1 { 
                color: #333; 
                margin-bottom: 10px;
              }
              .subtitle {
                color: #666;
                margin-bottom: 30px;
              }
              table { 
                width: 100%; 
                border-collapse: collapse; 
                background: white;
              }
              th, td { 
                padding: 15px; 
                text-align: left; 
                border-bottom: 1px solid #e0e0e0; 
              }
              th { 
                background-color: #667eea; 
                color: white; 
                font-weight: 600;
              }
              tr:hover { background-color: #f8f9fa; }
              .passed { 
                color: #28a745; 
                font-weight: bold; 
              }
              .failed { 
                color: #dc3545; 
                font-weight: bold; 
              }
              .btn { 
                background-color: #667eea;
                color: white;
                padding: 8px 16px;
                border-radius: 5px;
                text-decoration: none;
                display: inline-block;
                transition: background 0.3s;
              }
              .btn:hover { 
                background-color: #5568d3;
              }
              .stats {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
              }
              .stat-card {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 20px;
                border-radius: 10px;
                text-align: center;
              }
              .stat-value {
                font-size: 2em;
                font-weight: bold;
                margin: 10px 0;
              }
              .stat-label {
                opacity: 0.9;
                font-size: 0.9em;
              }
            </style>
          </head>
          <body>
            <div class="container">
              <h1>ðŸ§ª JMeter Load Test Reports</h1>
              <p class="subtitle">Automated stress testing results</p>
              
              <div class="stats" id="stats"></div>
              
              <table>
                <thead>
                  <tr>
                    <th>Run Date</th>
                    <th>Status</th>
                    <th>Total Requests</th>
                    <th>Success Rate</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="reportsList">
                  <tr><td colspan="5">Loading reports...</td></tr>
                </tbody>
              </table>
            </div>
            <script>
              async function loadReports() {
                try {
                  const files = await fetch('.')
                    .then(r => r.text())
                    .then(html => {
                      const parser = new DOMParser();
                      const doc = parser.parseFromString(html, 'text/html');
                      return Array.from(doc.querySelectorAll('a'))
                        .map(a => a.href)
                        .filter(href => href.includes('run_') && href.endsWith('.json'));
                    });
                  
                  const reports = [];
                  for (const file of files.slice(0, 15)) {
                    const data = await fetch(file).then(r => r.json());
                    reports.push(data);
                  }
                  
                  reports.sort((a, b) => b.timestamp.localeCompare(a.timestamp));
                  
                  // Calculate stats
                  const totalRuns = reports.length;
                  const passedRuns = reports.filter(r => r.status.includes('PASSED')).length;
                  const avgSuccess = reports.reduce((sum, r) => sum + parseFloat(r.success_rate), 0) / totalRuns;
                  
                  document.getElementById('stats').innerHTML = `
                    <div class="stat-card">
                      <div class="stat-label">Total Runs</div>
                      <div class="stat-value">${totalRuns}</div>
                    </div>
                    <div class="stat-card">
                      <div class="stat-label">Passed</div>
                      <div class="stat-value">${passedRuns}</div>
                    </div>
                    <div class="stat-card">
                      <div class="stat-label">Avg Success Rate</div>
                      <div class="stat-value">${avgSuccess.toFixed(1)}%</div>
                    </div>
                  `;
                  
                  const tbody = document.getElementById('reportsList');
                  tbody.innerHTML = reports.map(report => `
                    <tr>
                      <td>${report.date}</td>
                      <td class="${report.status.includes('PASSED') ? 'passed' : 'failed'}">${report.status}</td>
                      <td>${report.total}</td>
                      <td>${report.success_rate}%</td>
                      <td>
                        <a href="report_${report.timestamp}/index.html" class="btn" target="_blank">
                          ðŸ“Š View Report
                        </a>
                      </td>
                    </tr>
                  `).join('');
                } catch (error) {
                  console.error('Error loading reports:', error);
                  document.getElementById('reportsList').innerHTML = 
                    '<tr><td colspan="5">Error loading reports. Check console.</td></tr>';
                }
              }
              
              loadReports();
            </script>
          </body>
          </html>
          HTMLEOF

      # 12. Deploy to GitHub Pages
      - name: Deploy to GitHub Pages
        if: always()
        run: |
          git add reports/
          git commit -m "Update test reports - ${{ steps.jmeter_run.outputs.RUN_DATE }}" || echo "No changes to commit"
          git push origin gh-pages --force

      # 13. Upload artifacts as backup
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-logs-${{ steps.jmeter_run.outputs.TIMESTAMP }}
          path: |
            reports/*.jtl
            reports/report_*/
          retention-days: 30