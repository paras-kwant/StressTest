name: JMeter Zone Activity Monitor

on:
  schedule:
    - cron: "*/20 * * * *"
  workflow_dispatch:

jobs:
  jmeter-run:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Cache JMeter
        id: cache-jmeter
        uses: actions/cache@v3
        with:
          path: apache-jmeter
          key: jmeter-5.6.3
          restore-keys: |
            jmeter-

      - name: Install JMeter
        if: steps.cache-jmeter.outputs.cache-hit != 'true'
        run: |
          JMETER_VERSION=5.6.3
          wget https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-${JMETER_VERSION}.tgz -O jmeter.tgz
          tar -xzf jmeter.tgz
          mv apache-jmeter-${JMETER_VERSION} apache-jmeter

      - name: Add JMeter to PATH
        run: echo "$PWD/apache-jmeter/bin" >> $GITHUB_PATH

      - name: Setup reports directory
        run: |
          mkdir -p reports/raw
          mkdir -p reports/html

      - name: Fetch existing reports from gh-pages
        run: |
          git fetch origin gh-pages:gh-pages || echo "No gh-pages branch yet"
          if git show-ref --verify --quiet refs/heads/gh-pages; then
            git checkout gh-pages
            if [ -d "html" ]; then
              cp -r html/* reports/html/ 2>/dev/null || echo "No existing reports to copy"
            fi
            git checkout -
          else
            echo "gh-pages branch doesn't exist yet, this is the first run"
          fi

      - name: Run JMeter Test
        run: |
          TIMESTAMP=$(date +'%Y%m%d_%H%M%S')
          echo "Running test at: $TIMESTAMP"
          jmeter -n \
            -t tests/load_test_kwant.jmx \
            -l reports/raw/results_$TIMESTAMP.jtl \
            -e -o reports/html/report_$TIMESTAMP \
            -Jemail=${{ secrets.JMETER_EMAIL }} \
            -Jpassword=${{ secrets.JMETER_PASSWORD }}
          echo $TIMESTAMP > reports/latest_run.txt
          echo "Test completed!"

      - name: Check for JMeter assertion failures
        run: |
          TIMESTAMP=$(cat reports/latest_run.txt)
          echo "Checking JMeter results for assertion failures..."
          FAILS=$(grep 's="false"' reports/raw/results_$TIMESTAMP.jtl | wc -l)
          echo "Number of failed assertions: $FAILS"
          if [ "$FAILS" -gt 0 ]; then
            echo "❌ Test failed due to assertion failure!"
            exit 1
          fi
          echo "✅ All assertions passed."

      - name: Generate Report List
        run: |
          cd reports
          echo "[" > reports.json
          first=true
          for dir in html/report_*; do
            if [ -d "$dir" ]; then
              timestamp=$(basename "$dir" | sed 's/report_//')
              if [ "$first" = true ]; then
                first=false
              else
                echo "," >> reports.json
              fi
              echo -n "  {\"path\": \"$dir\", \"timestamp\": \"$timestamp\"}" >> reports.json
            fi
          done
          echo "" >> reports.json
          echo "]" >> reports.json
          cd ..

      - name: Generate Dashboard
        run: |
          cat > reports/index.html << 'HTMLEND'
          <!DOCTYPE html>
          <html lang="en">
          <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>Zone Activity API Monitor</title>
          <style>
          /* Add your existing CSS here */
          </style>
          </head>
          <body>
          <div id="reportsList">Loading reports...</div>
          <script>
            function toNepalTime(date){
              const utcTime = date.getTime() + (date.getTimezoneOffset()*60000);
              const nepalOffset = 5.75*60*60000;
              return new Date(utcTime+nepalOffset).toLocaleString('en-US',{
                year:'numeric', month:'2-digit', day:'2-digit',
                hour:'2-digit', minute:'2-digit', second:'2-digit',
                hour12:true
              });
            }
            const now = new Date();
            document.body.insertAdjacentHTML('afterbegin', '<p>Last updated: '+toNepalTime(now)+' NPT</p>');

            fetch('reports.json').then(r=>r.json()).then(reports=>{
              const list=document.getElementById('reportsList');
              if(!reports||reports.length===0){
                list.innerHTML='<p>Reports will appear after first run.</p>';
                return;
              }
              reports.sort((a,b)=>b.timestamp.localeCompare(a.timestamp));
              reports.slice(0,20).forEach((report,index)=>{
                const timestamp=report.timestamp;
                const year=timestamp.substring(0,4);
                const month=timestamp.substring(4,6);
                const day=timestamp.substring(6,8);
                const hour=timestamp.substring(9,11);
                const minute=timestamp.substring(11,13);
                const second=timestamp.substring(13,15);
                const date=new Date(year, month-1, day, hour, minute, second);
                const item=document.createElement('div');
                item.innerHTML='✓ Run #'+(index+1)+' - <a href="'+report.path+'/index.html" target="_blank">View Full Report</a> ('+toNepalTime(date)+')';
                list.appendChild(item);
              });
            });
          </script>
          </body>
          </html>
          HTMLEND

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./reports
          keep_files: true
          enable_jekyll: false

      - name: Cleanup old reports on gh-pages
        run: |
          cd reports/html
          REPORT_COUNT=$(ls -d report_* 2>/dev/null | wc -l)
          if [ $REPORT_COUNT -gt 20 ]; then
            ls -dt report_* | tail -n +21 | xargs rm -rf
          fi
          cd ../..

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-report-${{ github.run_number }}
          path: reports/
          retention-days: 30
