name: JMeter Zone Activity Monitor

on:
  schedule:
    - cron: "*/20 * * * *"
  workflow_dispatch:

jobs:
  jmeter-run:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Cache JMeter
        id: cache-jmeter
        uses: actions/cache@v3
        with:
          path: apache-jmeter
          key: jmeter-5.6.3
          restore-keys: |
            jmeter-

      - name: Install JMeter
        if: steps.cache-jmeter.outputs.cache-hit != 'true'
        run: |
          JMETER_VERSION=5.6.3
          wget https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-${JMETER_VERSION}.tgz -O jmeter.tgz
          tar -xzf jmeter.tgz
          mv apache-jmeter-${JMETER_VERSION} apache-jmeter

      - name: Add JMeter to PATH
        run: echo "$PWD/apache-jmeter/bin" >> $GITHUB_PATH

      - name: Setup reports directory
        run: |
          mkdir -p reports/raw
          mkdir -p reports/html

      - name: Fetch existing reports from gh-pages
        run: |
          git fetch origin gh-pages:gh-pages || echo "No gh-pages branch yet"
          if git show-ref --verify --quiet refs/heads/gh-pages; then
            echo "Restoring existing reports from gh-pages..."
            git checkout gh-pages
            mkdir -p temp_reports
            cp -r reports/html/* temp_reports/ 2>/dev/null || echo "No existing reports"
            git checkout main
            cp -r temp_reports/* reports/html/ 2>/dev/null || echo "Nothing to restore"
            rm -rf temp_reports
          else
            echo "gh-pages branch does not exist yet"
          fi

      - name: Run JMeter Test
        run: |
          TIMESTAMP=$(date +'%Y%m%d_%H%M%S')
          echo "Running test at: $TIMESTAMP"
          mkdir -p reports/html/report_$TIMESTAMP
          jmeter -n \
            -t tests/load_test_kwant.jmx \
            -l reports/raw/results_$TIMESTAMP.jtl \
            -e -o reports/html/report_$TIMESTAMP \
            -Jemail=${{ secrets.JMETER_EMAIL }} \
            -Jpassword=${{ secrets.JMETER_PASSWORD }}
          echo $TIMESTAMP > reports/latest_run.txt
          echo "Test completed!"

      - name: Cleanup old reports (keep last 20)
        run: |
          cd reports/html
          ls -dt report_* | tail -n +21 | xargs rm -rf || true
          cd ../..

      - name: Generate reports.json
        run: |
          cd reports
          echo "[" > reports.json
          first=true
          for dir in html/report_*; do
            if [ -d "$dir" ]; then
              timestamp=$(basename "$dir" | sed 's/report_//')
              if [ "$first" = true ]; then
                first=false
              else
                echo "," >> reports.json
              fi
              echo -n "  {\"path\": \"$dir\", \"timestamp\": \"$timestamp\"}" >> reports.json
            fi
          done
          echo "" >> reports.json
          echo "]" >> reports.json
          cat reports.json
          cd ..

      - name: Generate Dashboard
        run: |
          bash scripts/generate_dashboard.sh

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./reports
          keep_files: true
          enable_jekyll: false

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-report-${{ github.run_number }}
          path: reports/
          retention-days: 30
