name: JMeter Scheduled Run

on:
  schedule:
    - cron: "*/20 * * * *"   # runs every 20 minutes
  workflow_dispatch:

jobs:
  jmeter-run:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. Set up Java
      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      # 3. Install JMeter 5.6.3
      - name: Install JMeter
        run: |
          wget https://downloads.apache.org/jmeter/binaries/apache-jmeter-5.6.3.tgz
          tar -xzf apache-jmeter-5.6.3.tgz
          export PATH=$PWD/apache-jmeter-5.6.3/bin:$PATH

      # 4. Run JMeter CLI
      - name: Run JMeter CLI
        run: |
          TIMESTAMP=$(date +'%Y%m%d_%H%M%S')
          mkdir -p jmeter-logs
          export PATH=$PWD/apache-jmeter-5.6.3/bin:$PATH
          ./apache-jmeter-5.6.3/bin/jmeter -n \
            -t tests/load_test_kwant.jmx \
            -l jmeter-logs/results_$TIMESTAMP.jtl \
            -e -o jmeter-logs/report_$TIMESTAMP \
            -Jemail=${{ secrets.JMETER_EMAIL }} \
            -Jpassword=${{ secrets.JMETER_PASSWORD }}

      # 5. Cleanup old logs (keep last 20)
      - name: Cleanup old logs
        run: |
          cd jmeter-logs
          ls -tp | grep -v '/$' | tail -n +21 | xargs -I {} rm -- {}

      # 6. Upload logs & reports as artifacts
      - name: Upload logs & reports
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-logs-and-reports
          path: |
            jmeter-logs/*.jtl
            jmeter-logs/report_*/
