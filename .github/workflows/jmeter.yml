name: JMeter Scheduled Run

on:
  schedule:
    - cron: "*/20 * * * *"   # every 20 min
  workflow_dispatch:

jobs:
  jmeter-run:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repository
      - name: Checkout repo
        uses: actions/checkout@v3

      # 2. Set up Java
      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      # 3. Cache JMeter installation
      - name: Cache JMeter
        id: cache-jmeter
        uses: actions/cache@v3
        with:
          path: apache-jmeter
          key: jmeter-5.6.3
          restore-keys: |
            jmeter-

      # 4. Install JMeter (only if not cached)
      - name: Install JMeter
        if: steps.cache-jmeter.outputs.cache-hit != 'true'
        run: |
          JMETER_VERSION=5.6.3
          wget https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-${JMETER_VERSION}.tgz -O jmeter.tgz
          tar -xzf jmeter.tgz
          mv apache-jmeter-${JMETER_VERSION} apache-jmeter

      # 5. Add JMeter to PATH
      - name: Add JMeter to PATH
        run: echo "$PWD/apache-jmeter/bin" >> $GITHUB_PATH

      # 6. Verify JMX file exists
      - name: Verify JMX file
        run: |
          if [ ! -f tests/load_test_kwant.jmx ]; then
            echo "Error: tests/load_test_kwant.jmx not found!"
            echo "Contents of tests directory:"
            ls -la tests/ || echo "tests directory does not exist"
            exit 1
          fi
          echo "JMX file found successfully"

      # 7. Run JMeter CLI
      - name: Run JMeter CLI
        run: |
          TIMESTAMP=$(date +'%Y%m%d_%H%M%S')
          mkdir -p jmeter-logs
          jmeter -n \
            -t tests/load_test_kwant.jmx \
            -l jmeter-logs/results_$TIMESTAMP.jtl \
            -e -o jmeter-logs/report_$TIMESTAMP \
            -Jemail=${{ secrets.JMETER_EMAIL }} \
            -Jpassword=${{ secrets.JMETER_PASSWORD }}

      # 8. Cleanup old logs (keep last 20)
      - name: Cleanup old logs
        if: always()
        run: |
          cd jmeter-logs
          # Keep only the 20 most recent files
          ls -t | tail -n +21 | xargs -r rm -rf --

      # 9. Upload logs & reports
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-logs-and-reports-${{ github.run_number }}
          path: |
            jmeter-logs/*.jtl
            jmeter-logs/report_*/
          retention-days: 30