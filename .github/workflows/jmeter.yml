name: JMeter Zone Activity Monitor

on:
  schedule:
    - cron: "*/20 * * * *"
  workflow_dispatch:

jobs:
  jmeter-run:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Cache JMeter
        id: cache-jmeter
        uses: actions/cache@v3
        with:
          path: apache-jmeter
          key: jmeter-5.6.3
          restore-keys: |
            jmeter-

      - name: Install JMeter
        if: steps.cache-jmeter.outputs.cache-hit != 'true'
        run: |
          JMETER_VERSION=5.6.3
          wget https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-${JMETER_VERSION}.tgz -O jmeter.tgz
          tar -xzf jmeter.tgz
          mv apache-jmeter-${JMETER_VERSION} apache-jmeter

      - name: Add JMeter to PATH
        run: echo "$PWD/apache-jmeter/bin" >> $GITHUB_PATH

      - name: Setup reports directory
        run: |
          mkdir -p reports/raw
          mkdir -p reports/html

      - name: Run JMeter Test
        run: |
          TIMESTAMP=$(date +'%Y%m%d_%H%M%S')
          echo "Running test at: $TIMESTAMP"
          jmeter -n \
            -t tests/load_test_kwant.jmx \
            -l reports/raw/results_$TIMESTAMP.jtl \
            -e -o reports/html/report_$TIMESTAMP \
            -Jemail=${{ secrets.JMETER_EMAIL }} \
            -Jpassword=${{ secrets.JMETER_PASSWORD }}
          echo $TIMESTAMP > reports/latest_run.txt
          echo "Test completed!"

      - name: Check for failed assertions
        run: |
          TIMESTAMP=$(cat reports/latest_run.txt)
          echo "Checking JMeter results for failures..."
          FAILS=$(xmllint --xpath "count(//httpSample[@s='false'])" reports/raw/results_$TIMESTAMP.jtl)
          echo "Number of failed assertions: $FAILS"
          if [ "$FAILS" -gt 0 ]; then
            echo "âŒ Test failed due to assertion failure!"
            exit 1
          fi
          echo "âœ… All assertions passed."

      - name: Generate Report List
        run: |
          cd reports
          echo "[" > reports.json
          first=true
          for dir in html/report_*; do
            if [ -d "$dir" ]; then
              timestamp=$(basename "$dir" | sed 's/report_//')
              if [ "$first" = true ]; then
                first=false
              else
                echo "," >> reports.json
              fi
              echo -n "  {\"path\": \"$dir\", \"timestamp\": \"$timestamp\"}" >> reports.json
            fi
          done
          echo "" >> reports.json
          echo "]" >> reports.json
          cat reports.json
          cd ..

      - name: Generate Dashboard
        run: |
          cat > reports/index.html << 'HTMLEND'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Zone Activity API Monitor</title>
            <style>
              /* Your existing dashboard CSS here */
              body { font-family: 'Segoe UI', sans-serif; background: #f2f2f2; padding: 20px; }
              .container { max-width: 1200px; margin: auto; }
              .report-item { padding: 15px; margin: 10px 0; background: #fff; border-left: 5px solid #667eea; border-radius: 5px; }
              .run-number { font-weight: bold; color: #667eea; }
              .timestamp { color: #666; font-size: 0.9em; }
              .assertions { background: #f0f7ff; padding: 10px; border-radius: 5px; margin-top: 5px; }
              .assertion { display: flex; align-items: center; gap: 5px; }
              .icon { color: #4CAF50; font-weight: bold; }
              .view-btn { display: inline-block; padding: 5px 15px; background: #667eea; color: #fff; border-radius: 5px; text-decoration: none; margin-top: 5px; }
              .view-btn:hover { background: #4CAF50; }
            </style>
          </head>
          <body>
            <div class="container">
              <h1>ðŸŽ¯ Zone Activity API Monitor</h1>
              <p>Auto-refresh every 20 minutes</p>
              <p>Last updated: <span id="lastUpdate"></span></p>
              <div id="reportsList">Loading reports...</div>
            </div>
            <script>
              function toNepalTime(date) {
                const utcTime = date.getTime() + (date.getTimezoneOffset() * 60000);
                const nepalOffset = 5.75 * 60 * 60000;
                return new Date(utcTime + nepalOffset).toLocaleString('en-US', { hour12:true });
              }
              document.getElementById('lastUpdate').textContent = toNepalTime(new Date()) + ' NPT';
              fetch('reports.json')
                .then(res => res.json())
                .then(reports => {
                  const reportsList = document.getElementById('reportsList');
                  reports.sort((a,b)=>b.timestamp.localeCompare(a.timestamp));
                  reports.slice(0,20).forEach((report,index)=>{
                    const timestamp = report.timestamp;
                    const year = timestamp.substring(0,4);
                    const month = timestamp.substring(4,6);
                    const day = timestamp.substring(6,8);
                    const hour = timestamp.substring(9,11);
                    const min = timestamp.substring(11,13);
                    const sec = timestamp.substring(13,15);
                    const date = new Date(year,month-1,day,hour,min,sec);
                    const item = document.createElement('div');
                    item.className='report-item';
                    item.innerHTML='<div class="run-number">âœ“ Run #'+(index+1)+'</div>'+
                      '<div class="timestamp">ðŸ“… '+toNepalTime(date)+'</div>'+
                      '<div class="assertions"><div class="assertion"><span class="icon">âœ“</span> Response Code = 200 OK</div></div>'+
                      '<a href="'+report.path+'/index.html" class="view-btn" target="_blank">View Full Report â†’</a>';
                    reportsList.appendChild(item);
                  });
                });
            </script>
          </body>
          </html>
          HTMLEND

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./reports
          keep_files: true
          enable_jekyll: false

      - name: Cleanup old reports on gh-pages
        run: |
          cd reports/html
          REPORT_COUNT=$(ls -d report_* 2>/dev/null | wc -l)
          if [ $REPORT_COUNT -gt 20 ]; then
            ls -dt report_* | tail -n +21 | xargs rm -rf
          fi
          cd ../..

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-report-${{ github.run_number }}
          path: reports/
          retention-days: 30
